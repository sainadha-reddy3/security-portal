{% extends "layout.html" %}
{% block content %}

<!-- ===== TOP CARDS ===== -->
<div class="cards">

    <a href="/repos" class="card-link">
        <div class="card blue">
            <div class="icon">üìÅ</div>
            <div>
                <h2>{{ repo_summary|length }}</h2>
                <p>Projects Scanned</p>
            </div>
        </div>
    </a>

    <a href="/findings" class="card-link">
        <div class="card red">
            <div class="icon">üêû</div>
            <div>
                <h2>{{ high + low }}</h2>
                <p>Issues Found</p>
            </div>
        </div>
    </a>

    <a href="/findings?severity=LOW" class="card-link">
        <div class="card green">
            <div class="icon">‚úî</div>
            <div>
                <h2>{{ low }}</h2>
                <p>Passed without Errors</p>
            </div>
        </div>
    </a>

    <a href="/history" class="card-link">
        <div class="card orange">
            <div class="icon">‚ö†</div>
            <div>
                <h2>{{ trend_labels|length }}</h2>
                <p>Scan Runs</p>
            </div>
        </div>
    </a>

</div>


<!-- ===== 3 PANELS ===== -->
<div class="charts">

    <div class="panel">
        <h3>Issue Breakdown</h3>
        <canvas id="donut"></canvas>
    </div>

    <div class="panel">
        <h3>Lint Issue Trend</h3>
        <canvas id="trend"></canvas>
    </div>

    <div class="panel">
        <h3>Issues by Severity</h3>
        <p><b>High:</b> {{ high }}</p>
        <p><b>Low:</b> {{ low }}</p>
    </div>

</div>


<!-- ===== LOWER HALF ===== -->
<div class="bottom">

    <!-- Recent Results (FULL WIDTH STYLE) -->
    <div class="panel" style="flex:3;">
        <h3>Recent Lint Results</h3>
        <table>
            <tr>
                <th>Repository</th>
                <th>Issues</th>
                <th>Status</th>
            </tr>

            {% for repo, data in repo_summary.items() %}
            <tr>
                <td>
                    <a href="/repo/{{ repo }}" class="repo-link">{{ repo }}</a>
                </td>
                <td>{{ data.total }} Issues</td>
                <td>
                    {% if data.status == "Failed" %}
                        <span class="fail">Failed</span>
                    {% else %}
                        <span class="pass">Passed</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>

    <!-- Top Projects -->
    <div class="panel" style="flex:1.2;">
        <h3>Top Projects with Issues</h3>

        {% for repo, data in repo_summary.items()|sort(attribute='1.high', reverse=True) %}
            {% if data.high > 0 %}
            <div class="repo-box">
                <b>{{ repo }}</b><br>
                High: {{ data.high }} | Low: {{ data.low }}
            </div>
            {% endif %}
        {% endfor %}
    </div>

</div>


<!-- ===== CHARTS ===== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
new Chart(document.getElementById('donut'), {
    type: 'doughnut',
    data: {
        labels: ['High', 'Low'],
        datasets: [{
            data: [{{ high }}, {{ low }}],
            backgroundColor: ['#e74c3c','#2ecc71']
        }]
    },
    options: { plugins: { legend: { position: 'bottom' } } }
});

new Chart(document.getElementById('trend'), {
    type: 'line',
    data: {
        labels: {{ trend_labels|tojson }},
        datasets: [
            {
                label: 'High',
                data: {{ trend_high|tojson }},
                borderColor: '#e74c3c',
                tension: 0.4
            },
            {
                label: 'Low',
                data: {{ trend_low|tojson }},
                borderColor: '#2ecc71',
                tension: 0.4
            }
        ]
    },
    options: { plugins: { legend: { position: 'bottom' } } }
});
</script>

{% endblock %}
